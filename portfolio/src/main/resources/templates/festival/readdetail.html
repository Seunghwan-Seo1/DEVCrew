<html layout:decorate="~{layout}">
    <div layout:fragment="content">
        <div class="hero hero-inner">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-lg-6 mx-auto text-center">
                        <div class="intro-wrap">
                            <h1 class="mb-0">축제</h1>
                            <p class="text-white">축제는 혼자가 아닌 함께하는 즐거움! 친구와 함께 즐길 축제를 찾아보세요.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 사진 -->
        <section class="summary">
            <div class="row">
                <div class="col-md-6">
                    <img class="img-fluid" th:src="@{|https://bucketimgexamssh.s3.ap-northeast-2.amazonaws.com/${festival.fimg}|}" 
                    style="width: 1000px; height: 1000px; object-fit: contain; margin: 0 auto; display: block;">
                </div>

                <!-- 설명 -->
                <div class="col-md-6 d-flex flex-column justify-content-center">
                    <dl>
                        <div class="festival-info">
                            <dl>
                                <dt>작성자</dt>
                                <dd th:if="${festival.author != null}">[[${festival.author.username}]]</dd>
                            </dl>
                            <dl>
                                <dt>축제이름</dt>
                                <dd>[[${festival.fname}]]</dd>
                            </dl>
                            <dl>
                                <dt>장소</dt>
                                <dd>[[${festival.flocation}]]</dd>
                            </dl>
                            <dl>
                                <dt>축제설명</dt>
                                <dd th:utext="${festival.fdescription}"></dd>
                            </dl>
                        </div>
                    </dl>
                    
                    <style>
                        .festival-info {
                            background-color: #f8f9fa;
                            border: 1px solid #dee2e6;
                            border-radius: 8px;
                            padding: 20px;
                            margin-top: 20px;
                            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                        }
                        .festival-info dt {
                            font-weight: bold;
                            margin-top: 10px;
                            color: #007bff;
                        }
                        .festival-info dd {
                            margin: 0 0 10px;
                            line-height: 1.6;
                            color: #333;
                        }
                    </style>

                    <div id="map" style="width: 80%; height: 300px; margin: 20px 0;"></div>
                </div>
            </div>
        </section>

        <!-- 지도 -->
        <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=2dfaf20322b033bc10b994c8f32c8e9e&libraries=services"></script>
<script>
    function initializeMap() {
        var mapContainer = document.getElementById('map');

        if (!mapContainer) {
            console.error("지도 컨테이너가 존재하지 않습니다. 'map' ID를 가진 요소를 확인하세요.");
            return;
        }

        var mapOption = {
            center: new kakao.maps.LatLng(33.450701, 126.570667), // 기본 좌표 (제주도)
            level: 3
        };

        var map = new kakao.maps.Map(mapContainer, mapOption);

        // 마커 초기화
        var marker = new kakao.maps.Marker({
            position: mapOption.center
        });
        marker.setMap(map);

        // 주소 정보 가져오기
        var address = "[[${festival.flocation}]]";
        
        // 주소가 제공되지 않은 경우 처리
        if (!address || address.trim() === "") {
            console.error("주소 정보가 없습니다. 기본 좌표로 설정합니다.");
            alert("축제 위치 정보가 제공되지 않아 기본 위치를 표시합니다.");
            return;
        }

        // 주소 검색을 위한 Geocoder 객체
        var geocoder = new kakao.maps.services.Geocoder();

        geocoder.addressSearch(address, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                var newPosition = new kakao.maps.LatLng(result[0].y, result[0].x);
                map.setCenter(newPosition);
                marker.setPosition(newPosition);
            } else {
                console.error('주소 검색에 실패했습니다. 올바른 주소를 확인하세요.');
                alert('주소를 찾을 수 없습니다. 기본 위치를 표시합니다.');

                // 기본 위치로 설정 (서울 시청 좌표)
                var defaultPosition = new kakao.maps.LatLng(37.566535, 126.9779692); // 서울 시청 좌표
                map.setCenter(defaultPosition);
                marker.setPosition(defaultPosition);
            }
        });
    }

    // Kakao Maps API가 로드된 후에 initializeMap 호출
    window.onload = function() {
        if (kakao && kakao.maps) {
            initializeMap();
        } else {
            console.error("Kakao Maps API를 로드하지 못했습니다.");
        }
    };
</script>



        <!-- 추가 사진 -->
        <div class="untree_co-section">
            <div class="container">
                <div class="row">
                    <div class="col-6 col-md-6 col-lg-3">
                        <div class="media-1">
                            <a href="#" class="d-block mb-3">
                                <img th:src="@{|https://bucketimgexamssh.s3.ap-northeast-2.amazonaws.com/${festival.fimg2}|}" alt="Image" class="img-fluid">
                            </a>
                        </div>
                    </div>
                    <div class="col-6 col-md-6 col-lg-3">
                        <div class="media-1">
                            <a href="#" class="d-block mb-3">
                                <img th:src="@{|https://bucketimgexamssh.s3.ap-northeast-2.amazonaws.com/${festival.fimg3}|}" alt="Image" class="img-fluid">
                            </a>
                        </div>
                    </div>
                    <div class="col-6 col-md-6 col-lg-3">
                        <div class="media-1">
                            <a href="#" class="d-block mb-3">
                                <img th:src="@{|https://bucketimgexamssh.s3.ap-northeast-2.amazonaws.com/${festival.fimg4}|}" alt="Image" class="img-fluid">
                            </a>
                        </div>
                    </div>
                    <div class="col-6 col-md-6 col-lg-3">
                        <div class="media-1">
                            <a href="#" class="d-block mb-3">
                                <img th:src="@{|https://bucketimgexamssh.s3.ap-northeast-2.amazonaws.com/${festival.fimg5}|}" alt="Image" class="img-fluid">
                            </a>
                        </div>
                    </div>
                </div>
            </div>

        <style>
            .media-1 img {
                width: 100%;
                height: 200px;
                object-fit: cover;
            }
        </style>

        <!-- 리뷰 댓글 수정 삭제 별점 기능 추가 -->
        <style>
            .review-form {
                background-color: #ffffff;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 20px;
                max-width: 500px;
                margin: 0 auto;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }

            .review-form h2 {
                color: #6a0dad;
            }

            .review-form input[type="text"] {
                width: calc(100% - 110px);
                padding: 10px;
                border: 1px solid #ccc;
                border-radius: 4px;
                margin-right: 10px;
                font-size: 16px;
            }

            .review-form input[type="submit"] {
                padding: 10px 15px;
                border: none;
                border-radius: 4px;
                background-color: #8a2be2;
                color: white;
                cursor: pointer;
                transition: background-color 0.3s;
            }

            .review-form input[type="submit"]:hover {
                background-color: #7a1ea1;
            }

            .review-list {
                margin-top: 20px;
            }

            .review-item {
                background-color: #f9f5ff;
                border: 1px solid #dcdcdc;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 10px;
                transition: box-shadow 0.3s;
            }

            .review-item:hover {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            }

            .review-actions {
                display: flex;
                gap: 10px;
            }

            .review-actions button {
                padding: 5px 10px;
                border: none;
                border-radius: 3px;
                background-color: #8a2be2;
                color: white;
                cursor: pointer;
                transition: background-color 0.3s;
            }

            .review-actions button:hover {
                background-color: #7a1ea1;
            }
        </style>

        <div>
            <a href="javascript:void(0);" class="recommend btn btn-sm btn-outline-secondary" th:data-uri="@{|/festival/vote/${festival.fid}|}">
                추천
                <span class="badge rounded-pill bg-success" th:text="${#lists.size(festival.voter)}"></span>
            </a>
            <a href="javascript:void(0);" class="recommend2 btn btn-sm btn-outline-danger" th:data-uri="@{|/festival/devote/${festival.fid}|}">
                비추천
                <span class="badge rounded-pill bg-danger" th:text="${#lists.size(festival.devoter)}"></span>
            </a>
        </div>


        <div class="review-form">
            <h2>리뷰 남기기</h2>
            <form action="/freview/create" method="post">
                <input type="hidden" name="fid" th:value="${festival.fid}">
                <input type="hidden" name="${_csrf.parameterName}" th:value="${_csrf.token}">
                댓글 : <input type="text" name="frcontent" placeholder="여기에 댓글을 입력하세요" required>
                <input type="submit" value="등록">
            </form>
        </div>

        <div class="review-list">
    <th:block th:each="freview : ${festival.freviewList}">
        <div class="review-item">
            <p th:text="${freview.frcontent}"></p>
            <div class="review-actions">
                <button class="edit-button" th:data-review-id="${freview.frid}">수정</button>
                <button class="delete-button" th:data-review-id="${freview.frid}">삭제</button>

                <div>
                    <a href="javascript:void(0);" class="recommend btn btn-sm btn-outline-secondary" 
                       th:data-uri="@{|/freview/vote/${freview.frid}|}">
                        추천
                        <span class="badge rounded-pill bg-success" th:text="${#lists.size(freview.voter)}"></span>
                    </a>
                    <a href="javascript:void(0);" class="recommend2 btn btn-sm btn-outline-danger" 
                       th:data-uri="@{|/freview/devote/${freview.frid}|}">
                        비추천
                        <span class="badge rounded-pill bg-danger" th:text="${#lists.size(freview.devoter)}"></span>
                    </a>


					<dl>
						<dt>작성자</dt>
						<dd th:if="${freview.author != null}">[[${freview.author.username}]]</dd>
						</dl>
						<dl>
					</div>
            </div>
        </div>
    </th:block>
</div>


        <script>
            document.querySelectorAll('.edit-button').forEach(button => {
                button.addEventListener('click', function() {
                    const reviewId = this.getAttribute('data-review-id');
                    const fid = document.querySelector('input[name="fid"]').value;  // fid 값을 가져옴
                    editReview(reviewId, fid);
                });
            });

            document.querySelectorAll('.delete-button').forEach(button => {
                button.addEventListener('click', function() {
                    const reviewId = this.getAttribute('data-review-id');
                    const fid = document.querySelector('input[name="fid"]').value;  // fid 값을 가져옴
                    deleteReview(reviewId, fid);
                });
            });

            function editReview(reviewId, fid) {
                const reviewContent = document.querySelector(`[data-review-id="${reviewId}"]`).parentElement.previousElementSibling.innerText;
                const newContent = prompt("리뷰를 수정하세요:", reviewContent);

                if (newContent !== null) {
                    updateReview(reviewId, newContent, fid);
                }
            }

            function updateReview(reviewId, newContent, fid) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/freview/update/${reviewId}`;

                const inputContent = document.createElement('input');
                inputContent.type = 'hidden';
                inputContent.name = 'frcontent';
                inputContent.value = newContent;
                form.appendChild(inputContent);

                const inputFid = document.createElement('input');
                inputFid.type = 'hidden';
                inputFid.name = 'fid';
                inputFid.value = fid;  
                form.appendChild(inputFid);

                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = '${_csrf.parameterName}';
                csrfInput.value = '${_csrf.token}';
                form.appendChild(csrfInput);

                document.body.appendChild(form);
                form.submit();
            }

            function deleteReview(reviewId, fid) {
                if (confirm('정말로 이 리뷰를 삭제하시겠습니까?')) {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = `/freview/delete/${reviewId}`;

                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = '${_csrf.parameterName}';
                    csrfInput.value = '${_csrf.token}';
                    form.appendChild(csrfInput);
                    
                    const inputFid = document.createElement('input');
                    inputFid.type = 'hidden';
                    inputFid.name = 'fid';
                    inputFid.value = fid;  
                    form.appendChild(inputFid);


                    document.body.appendChild(form);
                    form.submit();
                }
            }

            const recommend_elements = document.getElementsByClassName("recommend");
            Array.from(recommend_elements).forEach(function(element) {
                element.addEventListener('click', function() {
                    if(confirm("정말로 추천하시겠습니까?")) {
                        location.href = this.dataset.uri;
                    }
                });
            });

            const recommend2_elements = document.getElementsByClassName("recommend2");
            Array.from(recommend2_elements).forEach(function(element) {
                element.addEventListener('click', function() {
                    if(confirm("정말로 비추천하시겠습니까?")) {
                        location.href = this.dataset.uri;
                    }
                });
            });
        </script>
    </div>
</html>
